var app = angular.module("app", ['mega-menu', 'ui.router', 'ui.bootstrap', 'app.login', 'app.success', 'ng-ripple', 'app.billCalc', 'cfp.hotkeys'])
    .config(function($provide, $httpProvider, $stateProvider, $urlRouterProvider) {})
    .run(['rippleConfig', 'BillsConfigService', function(rippleConfig, BillsConfigService) {
        rippleConfig.rippleOpacity = .2;
        rippleConfig.rippleDelay = 100;
    }]);

"use strict";
angular.module('app.billCalc', ['ui.router'])
    .config(function($stateProvider, $urlRouterProvider) {
        $stateProvider
            .state('billCalc', {
                url: '/bills',
                views: {
                    root: {
                        controller: 'BillCalcController',
                        templateUrl: 'app/billCalc/billCalc.html'
                    }
                },
                resolve: {
                    config: ['BillsConfigService', function(BillsConfigService) {
                        return BillsConfigService.init();
                    }]
                }
            });

    });

"use strict";
angular.module('app.login', ['ui.router'])
    .config(function($stateProvider, $urlRouterProvider) {
        $stateProvider
            .state('login', {
                url: '/login',
                views: {
                    root: {
                        controller: 'loginController',
                        templateUrl: 'app/login/login.html'
                    }
                },
                resolve: {
                    config: ['BillsConfigService', function(BillsConfigService) {
                        return BillsConfigService.init();
                    }]
                }
            });
        $urlRouterProvider.otherwise('/login');
    });
"use strict";
angular.module('app.success', ['ui.router'])
    .config(function($stateProvider, $urlRouterProvider) {
        $stateProvider
            .state('success', {
                url: '/success',
                views: {
                    root: {
                        controller: 'SuccessController',
                        templateUrl: 'app/successfull/success.html'
                    }
                }
            });

    });

angular.module('app').factory('BillsConfigService', BillsConfigService);

BillsConfigService.$inject = ['$log', '$http'];

function BillsConfigService($log, $http) {
    var service = {};
    var billsData = {};

    function setBillsCoreConfig(data) {
        billsData.billsConfig = data;
    }

    function getBillsCoreConfig() {
        return billsData.billsConfig;
    }

    service.init = function() {
        return $http.get('data.json').then(function(res) {
            var billsConfigDef = res.data || {};
            setBillsCoreConfig(billsConfigDef);
        });
    }

    service.get = function() {
        var billsConfigDef = getBillsCoreConfig();
        return billsConfigDef;
    }

    return service;

}

"use strict";

angular.module('app.billCalc').controller('BillCalcController', BillCalcController);
BillCalcController.$inject = ['$scope', '$state', '$q', '$timeout', 'BillsConfigService'];

function BillCalcController(scope, $state, $q, $timeout, BillsConfigService) {
    scope.message = "Bill Calucaution Screen Called"

    scope.signout = function() {
        $state.go('login');
    }

    scope.billCalculationPerHead = function(data) {
        scope.showDetails = false;
        var uniqueNames = getUniqueNames();
        var getIndividualBills = getIndividualSum(uniqueNames);
        scope.finalBills = getIndividualBills;
        var totalAmount = getTotalAmount(scope.finalBills);
        scope.totalCount = totalAmount;
        scope.showDetails = true;
    }

    function getTotalAmount(finalBills) {
        var individualAmounts = _.pluck(finalBills, "Amount");
        var finalBill = 0;
        _.each(individualAmounts, function(amountItem) {
            finalBill += amountItem;
        });

        return finalBill;
    }

    function getIndividualSum(names) {
        var finalArr = [];
        var billsData = getBillData();
        _.each(names, function(name) {
            var individualBills = _.filter(billsData, function(billItem) {
                return billItem.Name === name
            });
            var getSumOfIndividualBill = getSumOfBills(individualBills);
            var obj = {};
            obj.Name = name;
            obj.Amount = getSumOfIndividualBill;
            finalArr.push(obj);
        })
        return finalArr;
    }

    function getSumOfBills(individualBills) {
        var stringAmounts = _.pluck(individualBills, 'Amount');
        var amounts = stringToNumberConversion(stringAmounts);
        var finalSum = 0;
        _.each(amounts, function(amount) {
            finalSum = finalSum + amount;
        })
        return finalSum;
    }

    function stringToNumberConversion(stringAmounts) {
        var finalArr = [];
        _.each(stringAmounts, function(amount) {
            var amt = parseInt(amount);
            finalArr.push(amt);
        })
        return finalArr;
    }

    function getUniqueNames() {
        var uniqueNames = _.uniq(getBillData(), "Name");
        uniqueNames = _.pluck(uniqueNames, 'Name');;
        return uniqueNames;
    }

    function getBillForEachPerson() {
        var bills = scope.bills;
        console.log('Bill Details ', bills);
    }

    function getBillData() {
        var billsData = BillsConfigService.get();
        return billsData;
    }

    function init() {
        var billData = getBillData();
        scope.bills = billData;
    }

    init();

}

"use strict";
angular.module('app.login').controller('loginController', loginController);
loginController.$inject = ['$scope', '$state'];

function loginController(scope, $state) {
    scope.login = function() {
        console.log('Login Called');
        var isValidLogin = isValidUser();
        if (isValidLogin) {
            navigateToSuccess();
        } else {
            scope.message = "Invalid User";
        }
    }

    function isValidUser() {
        var isValid = false;
        if (_.isUndefined(scope.username)) {
            isValid = false
        } else {
            if (scope.username) {
                isValid = true;
            } else {
                isValid = false;
            }
        }
        return isValid;
    }

    function navigateToSuccess() {
        $state.go('success');
    }
}

"use strict";

angular.module('app.success').controller('SuccessController', SuccessController);
SuccessController.$inject = ['$scope', '$state'];

function SuccessController(scope, $state) {
    scope.toBillCalc = function() {
        console.log('Success Page -- Bill Calculation Called');
        $state.go('billCalc')
    }
}
